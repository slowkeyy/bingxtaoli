<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingX 專屬套利監控 (40% 返佣版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義滾動條與一些暗黑模式微調 */
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-text { text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- 頂部標題與設定區 -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 flex items-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    BingX 資金費率監控雷達
                </h1>
                <p class="text-slate-400 mt-1">針對 40% 返佣帳號量身打造，自動計算扣除手續費後的「真實淨利潤」</p>
            </div>
            
            <div class="glass-panel p-4 rounded-xl flex items-center gap-4 w-full md:w-auto">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">你的專屬安全線 (%)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="threshold-input" value="0.18" step="0.01" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 w-20 text-white font-mono focus:outline-none focus:border-blue-500">
                        <span class="text-sm text-slate-400">%</span>
                    </div>
                </div>
                <div class="h-10 border-l border-slate-600"></div>
                <div>
                    <button onclick="fetchBingXData()" id="refresh-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        手動刷新
                    </button>
                    <div id="last-update" class="text-xs text-slate-500 mt-1 text-right">等待更新...</div>
                </div>
            </div>
        </header>

        <!-- 狀態與錯誤提示 -->
        <div id="status-message" class="hidden mb-6 p-4 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-200 text-sm"></div>

        <!-- 數據表格區 -->
        <div class="glass-panel rounded-xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-800/80 border-b border-slate-700 text-slate-300 text-sm uppercase tracking-wider">
                            <th class="p-4 font-semibold">合約幣種 (BingX)</th>
                            <th class="p-4 font-semibold text-right">預測資金費率</th>
                            <th class="p-4 font-semibold text-right">扣除成本 (0.18%) 後淨利</th>
                            <th class="p-4 font-semibold text-right">結算倒數計時</th>
                            <th class="p-4 font-semibold text-center">操作建議</th>
                        </tr>
                    </thead>
                    <tbody id="data-body" class="divide-y divide-slate-800">
                        <tr>
                            <td colspan="5" class="p-8 text-center text-slate-500">
                                <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                正在載入 BingX 實時數據...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // BingX 永續合約資金費率 API 端點
        const BINGX_API_URL = 'https://open-api.bingx.com/openApi/swap/v2/quote/premiumIndex';
        // 使用 allorigins 作為 CORS 代理備案，避免前端直接呼叫被瀏覽器擋下
        const PROXY_URL = `https://api.allorigins.win/get?url=${encodeURIComponent(BINGX_API_URL)}`;

        let autoRefreshInterval;

        // 初始化
        window.onload = () => {
            fetchBingXData();
            // 每 60 秒自動刷新一次
            autoRefreshInterval = setInterval(fetchBingXData, 60000);
        };

        async function fetchBingXData() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshBtn.innerHTML = '更新中...';

            try {
                let dataList = [];
                let response;

                // 優先嘗試直接呼叫 BingX API
                try {
                    response = await fetch(BINGX_API_URL);
                    const json = await response.json();
                    if (json.code === 0 && json.data) {
                        dataList = json.data;
                    } else {
                        throw new Error('BingX API 回傳格式錯誤');
                    }
                } catch (directError) {
                    console.log('直接連線失敗，嘗試使用 Proxy 代理獲取數據...', directError);
                    // 如果直接呼叫失敗 (通常是 CORS 問題)，改用 Proxy
                    response = await fetch(PROXY_URL);
                    const proxyJson = await response.json();
                    const json = JSON.parse(proxyJson.contents);
                    
                    if (json.code === 0 && json.data) {
                        dataList = json.data;
                        showStatus('目前透過跨域代理獲取數據。若部署至正式伺服器，建議由後端直接抓取以降低延遲。', 'warning');
                    } else {
                        throw new Error('無法從代理獲取有效數據');
                    }
                }

                processAndRenderData(dataList);
                updateTimestamp();

            } catch (error) {
                console.error("抓取失敗:", error);
                showStatus(`數據抓取失敗：${error.message}。<br>BingX 可能限制了網頁端的頻繁請求。`, 'error');
                
                // 若完全失敗，載入模擬數據讓你看效果
                loadMockData();
            } finally {
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                refreshBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    手動刷新
                `;
            }
        }

        function processAndRenderData(dataList) {
            // 獲取使用者設定的安全線 (預設 0.18%)
            const thresholdInput = document.getElementById('threshold-input').value;
            const safeThreshold = parseFloat(thresholdInput) / 100; // 轉為小數

            const tbody = document.getElementById('data-body');
            tbody.innerHTML = '';

            const now = new Date().getTime();

            // 處理數據：計算淨利、過濾並排序
            const processedData = dataList.map(item => {
                // BingX 回傳的費率字串轉數字
                const fundingRate = parseFloat(item.lastFundingRate);
                // 淨利潤 = 資金費率 - 安全線摩擦成本 (這裡主要針對做空合約吃正費率的場景)
                const netProfit = fundingRate - safeThreshold;
                // 計算倒數時間
                const nextFundingTime = parseInt(item.nextFundingTime);
                const timeDiff = nextFundingTime - now;

                return {
                    symbol: item.symbol,
                    fundingRate: fundingRate,
                    netProfit: netProfit,
                    timeDiff: timeDiff,
                    nextTimeLabel: formatCountdown(timeDiff)
                };
            });

            // 過濾掉時間已經過去的錯誤數據，並由「淨利潤」高到低排序
            const sortedData = processedData
                .filter(item => item.timeDiff > 0)
                .sort((a, b) => b.netProfit - a.netProfit);

            // 渲染至表格
            sortedData.forEach(item => {
                // 只顯示前 30 名的高費率幣種，保持頁面乾淨
                if (item.fundingRate < 0.0001) return; 

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 transition-colors";
                
                // 判斷是否為「真肥肉」 (淨利大於 0)
                const isProfitable = item.netProfit > 0;
                
                // 數字格式化 (轉回百分比顯示)
                const rateStr = (item.fundingRate * 100).toFixed(4) + '%';
                const netProfitStr = (item.netProfit * 100).toFixed(4) + '%';

                tr.innerHTML = `
                    <td class="p-4 font-bold text-white flex items-center gap-2">
                        ${item.symbol.replace('-USDT', '')} <span class="text-xs font-normal text-slate-500 bg-slate-800 px-2 py-0.5 rounded">USDT</span>
                    </td>
                    <td class="p-4 text-right font-mono text-blue-400">
                        +${rateStr}
                    </td>
                    <td class="p-4 text-right font-mono font-bold ${isProfitable ? 'text-green-400 glow-text' : 'text-slate-500'}">
                        ${isProfitable ? '+' : ''}${netProfitStr}
                    </td>
                    <td class="p-4 text-right font-mono text-orange-300">
                        ${item.nextTimeLabel}
                    </td>
                    <td class="p-4 text-center">
                        ${isProfitable 
                            ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-300 border border-green-700">✅ 可進場狙擊</span>' 
                            : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-800 text-slate-400">觀望中</span>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (tbody.innerHTML === '') {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500">目前沒有顯著的正資金費率標的。</td></tr>`;
            }
        }

        // 時間倒數格式化轉換器
        function formatCountdown(milliseconds) {
            if (milliseconds <= 0) return "結算中";
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').innerText = `最後更新: ${now.toLocaleTimeString()}`;
            document.getElementById('status-message').classList.add('hidden');
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-message');
            el.innerHTML = msg;
            el.className = `mb-6 p-4 rounded-lg text-sm ${
                type === 'error' ? 'bg-red-900/50 border border-red-700 text-red-200' : 
                'bg-yellow-900/50 border border-yellow-700 text-yellow-200'
            }`;
            el.classList.remove('hidden');
        }

        // 用於展示效果的模擬數據 (當 API 被完全阻擋時觸發)
        function loadMockData() {
            showStatus('無法連線至交易所，目前顯示為<b>展示用模擬數據</b>。請檢查網路或將程式碼部署至後端環境。', 'error');
            const now = new Date().getTime();
            const mockData = [
                { symbol: "PIPPIN-USDT", lastFundingRate: "0.00285", nextFundingTime: now + 3500000 },
                { symbol: "DOGE-USDT", lastFundingRate: "0.00195", nextFundingTime: now + 7200000 },
                { symbol: "BTC-USDT", lastFundingRate: "0.0001", nextFundingTime: now + 14400000 },
                { symbol: "SOL-USDT", lastFundingRate: "0.0015", nextFundingTime: now + 800000 },
                { symbol: "PEPE-USDT", lastFundingRate: "0.0032", nextFundingTime: now + 1800000 }
            ];
            processAndRenderData(mockData);
        }
    </script>
</body>
</html>
