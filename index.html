<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingX å°ˆå±¬å¥—åˆ©ç›£æ§ (Discord æ¨æ’­ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-text { text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡è¨­å®šå€ -->
        <header class="mb-8 space-y-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 flex items-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    BingX è³‡é‡‘è²»ç‡ç›£æ§é›·é” (Discord ç‰ˆ)
                </h1>
                <p class="text-slate-400 mt-1">é‡å° 40% è¿”ä½£å¸³è™Ÿï¼Œè‡ªè¨‚å¤šé‡æ¢ä»¶ä¸¦è‡ªå‹•ç™¼é€ Discord å¡ç‰‡é€šçŸ¥</p>
            </div>

            <!-- å…¨æ–°è¨­è¨ˆçš„ç¶²æ ¼è¨­å®šå€ -->
            <div class="glass-panel p-5 rounded-xl grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- å€å¡Š 1: è©¦ç®—è¨­å®š (ç´”é¡¯ç¤ºç”¨) -->
                <div class="space-y-3">
                    <h3 class="text-sm font-semibold text-blue-300 border-b border-slate-700 pb-2 flex items-center gap-2">
                        ğŸ’¡ æˆæœ¬è©¦ç®— (å½±éŸ¿è¡¨æ ¼é¡¯ç¤º)
                    </h3>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">å°ˆå±¬å®‰å…¨ç·š (%) - é–‹å¹³å€‰ç¸½æ‘©æ“¦æˆæœ¬</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="cost-input" value="0.18" step="0.01" class="w-24 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                            <span class="text-xs text-slate-500">ç”¨ä¾†è¨ˆç®—å°ˆå±¬æ·¨åˆ©</span>
                        </div>
                    </div>
                </div>

                <!-- å€å¡Š 2: è­¦å ±æ¢ä»¶ (è§¸ç™¼ç”¨) -->
                <div class="space-y-3 md:border-l border-slate-700 md:pl-6">
                    <h3 class="text-sm font-semibold text-red-300 border-b border-slate-700 pb-2 flex items-center gap-2">
                        ğŸš¨ è­¦å ±è§¸ç™¼æ¢ä»¶ (éœ€åŒæ™‚æ»¿è¶³)
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">é æ¸¬è³‡é‡‘è²»ç‡ â‰¥ (%)</label>
                            <input type="number" id="funding-threshold-input" value="0.20" step="0.01" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">çµç®—å€’æ•¸ â‰¤ (åˆ†é˜)</label>
                            <input type="number" id="time-limit-input" value="120" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">åŒå¹£ç¨®é‡è¤‡é€šçŸ¥å†·å» (åˆ†é˜)</label>
                            <input type="number" id="cooldown-input" value="30" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500" title="é¿å…åŒä¸€å€‹å¹£åœ¨çŸ­æ™‚é–“å…§ç˜‹ç‹‚æ´—ç‰ˆ">
                        </div>
                    </div>
                </div>

                <!-- å€å¡Š 3: Discord è¨­å®šèˆ‡æŒ‰éˆ• -->
                <div class="space-y-3 md:border-l border-slate-700 md:pl-6 flex flex-col">
                    <h3 class="text-sm font-semibold text-slate-300 border-b border-slate-700 pb-2 flex items-center justify-between">
                        <span class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-[#5865F2]" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.028zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            Discord æ¨æ’­
                        </span>
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="dc-enable" class="sr-only">
                                <div class="block bg-slate-600 w-10 h-6 rounded-full transition-colors"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                            </div>
                            <span class="ml-2 text-xs text-slate-400">å•Ÿç”¨</span>
                        </label>
                    </h3>
                    <div class="mt-2 flex-grow">
                        <input type="text" id="dc-webhook" value="https://discord.com/api/webhooks/1474796511761268879/fZfaGIKYd92OUOD3WOSaYuhvie6A7rZKMXHAdOvlqbmxL0fnE-QfJcQUISORisER10f7" placeholder="Webhook URL" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-2 text-white font-mono text-xs focus:outline-none focus:border-blue-500 mb-3">
                        <button onclick="fetchBingXData()" id="refresh-btn" class="bg-[#5865F2] hover:bg-[#4752C4] text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 w-full shadow-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            ç«‹åˆ»æƒæ
                        </button>
                        <!-- æŠŠé€™è¡Œè£œå›ä¾†ï¼Œé¿å… JS æ‰¾ä¸åˆ°å…ƒç´ å ±éŒ¯ -->
                        <div id="last-update" class="text-xs text-slate-500 text-center mt-2">ç­‰å¾…æ›´æ–°...</div>
                    </div>
                </div>
            </div>
        </header>

        <div id="status-message" class="hidden mb-6 p-4 rounded-lg text-sm"></div>

        <!-- æ•¸æ“šè¡¨æ ¼å€ -->
        <div class="glass-panel rounded-xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-800/80 border-b border-slate-700 text-slate-300 text-sm uppercase tracking-wider">
                            <th class="p-4 font-semibold w-1/4">åˆç´„å¹£ç¨® (BingX)</th>
                            <th class="p-4 font-semibold text-right w-1/4">çµç®—å€’æ•¸è¨ˆæ™‚</th>
                            <th class="p-4 font-semibold text-right w-1/4">é æ¸¬è³‡é‡‘è²»ç‡</th>
                            <!-- å°‡æ·¨åˆ©å€å¡Šç¨ç«‹å‡ºä¾†ï¼ŒåŠ ä¸Šç‰¹æ®ŠèƒŒæ™¯è‰² -->
                            <th class="p-4 font-semibold text-right w-1/4 bg-blue-900/20 border-l border-blue-800/50 text-blue-300">
                                å°ˆå±¬æ·¨åˆ© <span class="text-xs font-normal text-slate-400 block">(æ‰£é™¤å®‰å…¨ç·šå¾Œ)</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="data-body" class="divide-y divide-slate-800">
                        <tr><td colspan="4" class="p-8 text-center text-slate-500">é»æ“Šä¸Šæ–¹ã€Œç«‹åˆ»æƒæã€é–‹å§‹ç›£æ§</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <style>
        /* Toggle Switch CSS */
        input:checked ~ .block { background-color: #5865F2; }
        input:checked ~ .dot { transform: translateX(100%); }
    </style>

    <script>
        const BINGX_API_URL = 'https://open-api.bingx.com/openApi/swap/v2/quote/premiumIndex';
        // æ”¹å›ä½¿ç”¨è¼ƒç©©å®šçš„ allorigins raw æ¨¡å¼ä¾†ç¹éé è¦½ç’°å¢ƒçš„ CORS é™åˆ¶
        const PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(BINGX_API_URL)}`;

        let notifiedSymbols = {}; 

        window.onload = () => {
            // è¼‰å…¥æœ¬åœ°å„²å­˜çš„è¨­å®šå€¼
            const inputs = ['cost-input', 'time-limit-input', 'funding-threshold-input', 'cooldown-input', 'dc-webhook'];
            inputs.forEach(id => {
                const saved = localStorage.getItem(id);
                if (saved !== null) document.getElementById(id).value = saved;
                document.getElementById(id).addEventListener('change', (e) => localStorage.setItem(id, e.target.value));
            });

            if(localStorage.getItem('dcEnable') === 'true') document.getElementById('dc-enable').checked = true;
            document.getElementById('dc-enable').addEventListener('change', (e) => localStorage.setItem('dcEnable', e.target.checked));

            setInterval(fetchBingXData, 60000);
            fetchBingXData();
        };

        async function fetchBingXData() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshBtn.innerHTML = 'æƒæä¸­...';

            try {
                let dataList = [];
                try {
                    const response = await fetch(BINGX_API_URL);
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                    const json = await response.json();
                    if (json.code === 0) dataList = json.data;
                    else throw new Error('API æ ¼å¼éŒ¯èª¤');
                } catch (e) {
                    console.log("å®˜æ–¹ API ç›´é€£å¤±æ•—ï¼Œåˆ‡æ›è‡³ä»£ç†ä¼ºæœå™¨...", e.message);
                    const response = await fetch(PROXY_URL);
                    if (!response.ok) throw new Error(`ä»£ç†ä¼ºæœå™¨æ‹’çµ•é€£ç·š (HTTP ${response.status})`);
                    
                    // å…ˆä»¥ç´”æ–‡å­—è®€å–ï¼Œé¿å…é JSON æ ¼å¼å°è‡´ç³»çµ±å´©æ½°
                    const textData = await response.text();
                    try {
                        const json = JSON.parse(textData);
                        if (json.code === 0) dataList = json.data;
                        else throw new Error('ä»£ç†ç²å–çš„ API æ ¼å¼éŒ¯èª¤');
                    } catch (parseError) {
                        throw new Error('ä»£ç†ä¼ºæœå™¨å›å‚³äº†ç„¡æ•ˆçš„æ•¸æ“š');
                    }
                }

                processAndRenderData(dataList);
                updateTimestamp();
            } catch (error) {
                console.error(error);
                showStatus(`æƒæå¤±æ•—ï¼š${error.message}ã€‚<br>è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–å°‡ç¨‹å¼ç¢¼éƒ¨ç½²è‡³ Vercel/GitHub Pages ä»¥ç²å¾—æœ€ä½³é€£ç·šå“è³ªã€‚`, 'error');
            } finally {
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                refreshBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> ç«‹åˆ»æƒæ';
            }
        }

        function processAndRenderData(dataList) {
            // å–å¾—ä½¿ç”¨è€…è¨­å®šçš„æ¢ä»¶
            const safeCost = parseFloat(document.getElementById('cost-input').value) / 100;
            const targetTimeLimitMinutes = parseInt(document.getElementById('time-limit-input').value);
            const targetFundingRate = parseFloat(document.getElementById('funding-threshold-input').value) / 100;
            const cooldownMinutes = parseInt(document.getElementById('cooldown-input').value) || 0;
            
            const isDcEnabled = document.getElementById('dc-enable').checked;
            const dcWebhookUrl = document.getElementById('dc-webhook').value;

            const tbody = document.getElementById('data-body');
            tbody.innerHTML = '';
            const now = new Date().getTime();
            let alertsToSend = [];

            const sortedData = dataList
                .map(item => {
                    const fundingRate = parseFloat(item.lastFundingRate);
                    const netProfit = fundingRate - safeCost; // å‹•æ…‹æ‰£é™¤ä½ è¨­å®šçš„å®‰å…¨ç·š
                    const timeDiff = parseInt(item.nextFundingTime) - now;
                    return { symbol: item.symbol, fundingRate, netProfit, timeDiff };
                })
                .filter(item => item.timeDiff > 0 && item.fundingRate > 0.0001) 
                .sort((a, b) => b.netProfit - a.netProfit);

            sortedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 transition-colors border-b border-slate-800";
                
                const timeDiffMinutes = Math.floor(item.timeDiff / 60000);
                const isProfitable = item.netProfit > 0;
                
                // --- åˆ¤æ–·æ˜¯å¦è§¸ç™¼è­¦å ± ---
                // ç°¡åŒ–ç‚ºï¼š1.å€’æ•¸æ™‚é–“å…§ 2.åŸå§‹è²»ç‡é”æ¨™ (ä¸å†æª¢æŸ¥æ·¨åˆ©æ½¤)
                const isTriggered = 
                    timeDiffMinutes <= targetTimeLimitMinutes &&
                    item.fundingRate >= targetFundingRate;

                if (isTriggered) {
                    // å¦‚æœè§¸ç™¼è­¦å ±ï¼Œçµ¦æ•´åˆ—ä¸€å€‹å¾®ç´…è‰²çš„é«˜äº®æç¤º
                    tr.classList.add('bg-red-900/20'); 
                    
                    const lastNotified = notifiedSymbols[item.symbol] || 0;
                    // ä½¿ç”¨é¢æ¿ä¸Šè¨­å®šçš„å†·å»æ™‚é–“ (å°‡åˆ†é˜è½‰ç‚ºæ¯«ç§’)
                    if (now - lastNotified > cooldownMinutes * 60 * 1000) {
                        alertsToSend.push(item);
                        notifiedSymbols[item.symbol] = now; 
                    }
                }

                tr.innerHTML = `
                    <td class="p-4 font-bold text-white">${item.symbol.replace('-USDT', '')}</td>
                    <td class="p-4 text-right font-mono text-orange-300">${formatCountdown(item.timeDiff)}</td>
                    <td class="p-4 text-right font-mono text-blue-400">+${(item.fundingRate * 100).toFixed(4)}%</td>
                    <!-- å°ˆå±¬æ·¨åˆ©æ¬„ä½ï¼šåŠ ä¸Šç¨ç«‹èƒŒæ™¯è‰²èˆ‡é‚Šæ¡†ä¾†å€éš” -->
                    <td class="p-4 text-right font-mono font-bold bg-blue-900/10 border-l border-blue-800/30 ${isProfitable ? 'text-green-400 glow-text' : 'text-slate-500'}">
                        ${isProfitable ? '+' : ''}${(item.netProfit * 100).toFixed(4)}%
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (tbody.innerHTML === '') tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-500">ç›®å‰ç„¡æ•¸æ“š</td></tr>`;

            if (isDcEnabled && dcWebhookUrl && alertsToSend.length > 0) {
                sendDiscordAlert(alertsToSend, dcWebhookUrl, safeCost);
            }
        }

        async function sendDiscordAlert(alerts, webhookUrl, currentSafeCost) {
            // Discord é™åˆ¶å–®æ¬¡ç™¼é€æœ€å¤šåªèƒ½åŒ…å« 10 å€‹ embeds (è‡ªå‹•åˆ†æ‰¹è™•ç†)
            const chunkSize = 10;
            let successCount = 0;

            for (let i = 0; i < alerts.length; i += chunkSize) {
                const chunk = alerts.slice(i, i + chunkSize);
                const embeds = chunk.map(item => {
                    const rate = (item.fundingRate * 100).toFixed(4);
                    const profit = (item.netProfit * 100).toFixed(4);
                    const costStr = (currentSafeCost * 100).toFixed(2);
                    const mins = Math.floor(item.timeDiff / 60000);

                    return {
                        title: `ğŸ¯ ${item.symbol} å¥—åˆ©æ©Ÿæœƒ`,
                        color: 3066993,
                        fields: [
                            { name: "é æ¸¬è³‡é‡‘è²»ç‡", value: `+${rate}%`, inline: true },
                            { name: `ä¿è­‰æ·¨åˆ© (å·²æ‰£${costStr}%)`, value: `**+${profit}%**`, inline: true },
                            { name: "çµç®—å€’æ•¸", value: `â³ å‰© ${mins} åˆ†é˜`, inline: false }
                        ],
                        footer: { text: "BingX å°ˆå±¬ç‹™æ“Šé›·é”" },
                        timestamp: new Date().toISOString()
                    };
                });

                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            // åªæœ‰ç¬¬ä¸€æ‰¹è¨Šæ¯åŠ ä¸Š @everyone æˆ–å¼•è¨€æé†’
                            content: i === 0 ? "ğŸš¨ **é«˜æ½›åŠ›è³‡é‡‘è²»ç‡é”æ¨™ï¼** è«‹ç›¡é€Ÿè©•ä¼°é€²å ´ã€‚" : "",
                            embeds: embeds
                        })
                    });
                    
                    if (response.ok || response.status === 204) {
                        successCount += chunk.length;
                    } else throw new Error("ç™¼é€å¤±æ•—");
                } catch (error) {
                    console.error(error);
                    showStatus(`Discord é€šçŸ¥ç™¼é€å¤±æ•—: è«‹æª¢æŸ¥ Webhook ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚`, 'error');
                    return; // ç™¼ç”ŸéŒ¯èª¤ä¸­æ–·å¾ŒçºŒåˆ†æ‰¹ç™¼é€
                }
            }

            if (successCount > 0) {
                showStatus(`âœ… æˆåŠŸç™¼é€ ${successCount} ç­†è­¦å ±è‡³ Discord é »é“`, 'success');
            }
        }

        function formatCountdown(ms) {
            if (ms <= 0) return "çµç®—ä¸­";
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 3600)}h ${Math.floor((s % 3600) / 60)}m ${s % 60}s`;
        }

        function updateTimestamp() {
            // åŠ ä¸Šå®‰å…¨æª¢æŸ¥ï¼Œé¿å…ç•«é¢èª¿æ•´æ™‚æ‰¾ä¸åˆ°å…ƒç´ è€Œç•¶æ©Ÿ
            const lastUpdateEl = document.getElementById('last-update');
            if (lastUpdateEl) lastUpdateEl.innerText = `æœ€å¾Œæƒæ: ${new Date().toLocaleTimeString()}`;
            
            setTimeout(() => { 
                const statusEl = document.getElementById('status-message');
                if (statusEl) statusEl.classList.add('hidden'); 
            }, 3000);
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-message');
            el.innerHTML = msg;
            el.className = `mb-6 p-4 rounded-lg text-sm ${type === 'error' ? 'bg-red-900/50 border border-red-700 text-red-200' : 'bg-green-900/50 border border-green-700 text-green-200'}`;
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>
